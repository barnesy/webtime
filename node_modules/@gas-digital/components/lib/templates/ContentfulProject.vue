<template>
  <Directory class="dark" :bgImage="'url(' + $page.projects.headerImage.file.url + ')' ">

  <template #page-header>
    <Header class="v4"  borderColor="var(--dark-teal)">
      <template>{{ $page.projects.projectName }}</template>
      <template #support>{{ $page.projects.projectOverview }} </template>
      <template #context></template>
    </Header>
  </template>

  <PageSection padding="3rem 3rem 8rem" class="narrow">
    <template #title>Project Details</template>
    <template>
      <div id="map"></div>
      <div v-html="content" />
    </template>
  </PageSection>

  <PageSection padding="3rem 3rem 8rem">
    <template #title>Stay Connected </template>

    <template>
      <MultiColumn>
        <Column colColor="var(--light-grey)">
          <template #columnTitle>On social media</template>
          <template>Look for project news and updates on <a :href="'https://twitter.com/' + $page.projects.outreach[0].accountName">Twitter</a>.</template>
        </Column>

        <Column colColor="var(--light-grey)">
          <template #columnTitle>By phone</template>
          <template>{{ $page.projects.phone}}</template>
        </Column>

        <Column colColor="var(--light-grey)">
          <template #columnTitle>By email</template>
          <template><a :href="'mailto:'+ $page.projects.email">Email the project team</a></template>
        </Column>
      </MultiColumn>
    </template>
  </PageSection>

  <PageSection v-if="$page.projects.pdfs[0]" bgColor="var(--light-grey)">
    <template #title>Project Information</template>

    <template>
      <CardGroup>
        <Card class="small" v-for="doc in $page.projects.pdfs" :key="doc.id" :url="doc.file.url" >
          <template #image>
            <g-image src="https://images.ctfassets.net/ncgri9n8y2w0/5ckhKdIui5kZyft5iVsJd2/a81e325650223ea1b32096ec96ea76ba/check-list.svg" />
          </template>

          <template>
            {{ doc.title }}
          </template>
        </Card>
      </CardGroup>
    </template>
  </PageSection>

  <Impact />

  <PageSection bgColor="var(--light-grey)" padding="6rem 3rem 6rem">
    <template><a :href="'mailto:'+ $page.projects.contactEmail">Media Contact: {{$page.projects.contact}}</a></template>
  </PageSection>

  </Directory>
</template>

<page-query>
query ($path: String!){
	projects:contentfulProject(path: $path) {
    projectName
    slug
    headerImage {
      file {
        url
      }
    }
    projectOverview
    projectDetails
    territory
    contact
    contactEmail
    phone
    email
    pdfs {
      id
      title
      description
      file {
        url
      }
    }
    geoJson {
      file {
        url
      }
    }
    outreach {
      icon {
        file {
          url
        }
      }
      accountName
      url
    }
  }
}
</page-query>

<script>
let placeholder =  "https://images.ctfassets.net/ncgri9n8y2w0/4TrUKxtHvhJEMH1Ki0P8GO/c61275e1dbcea68f5600dbfe1211e7de/dark-green.png"

const axios = require("axios");

import MarkdownIt from 'markdown-it'

import mapboxgl from '!mapbox-gl'
import 'mapbox-gl/dist/mapbox-gl.css'

mapboxgl.accessToken = process.env.GRIDSOME_MAPBOX_TOKEN
var map = {}
let bounds = [[43.520696,-96.6652837],[29.52553,-74.9826837]]

export default {
  metaInfo() {
    return {
      title: "Projects: " + this.$page.projects.projectName,
      meta: [
        {
          name: 'description',
          content: this.$page.projects.projectOverview
        },
        {
          property: 'og:title',
          content: "Projects: " + this.$page.projects.projectName
        },
        {
          property: 'og:description',
          content: this.$page.projects.projectOverview
        },
        {
          property: 'og:image',
          content: "https:" + this.ogImage
        },
        {
          property: 'og:url',
          content: "https://www.southerncompanygas.com/safety/" + this.$page.projects.slug
        },
      ],
    }
  },

  methods: {
    convertTerritory: function(string) {
      return (string.toString())
    }
  },
  data() {
    return {
      ogImage: placeholder
    }
  },
  computed: {
    content() {
      const md = new MarkdownIt()
      return md.render(this.$page.projects.projectDetails)
    },
  },
  mounted() {
    let img = this.$page.projects.headerImage
    this.ogImage = (img) ?  img.file.url : placeholder

    let geoJsonURL = 'https:' + this.$page.projects.geoJson.file.url

    axios.get(geoJsonURL).then(resp => {
      let data = resp.data

      let startSegment = data[0]
      let endSegment = data[data.length - 1]

      let startCoord = startSegment.geometry.coordinates[0][0]
      let lastCoord = endSegment.geometry.coordinates[endSegment.geometry.coordinates.length - 1]
      let endCoord =  lastCoord[lastCoord.length - 1]


      let bounds = [
        startCoord,
        endCoord
      ]

      this.map.fitBounds(bounds, {padding: 150})

      const start = new mapboxgl.Marker()
        .setLngLat(startCoord)
        .addTo(this.map);

      const end = new mapboxgl.Marker()
        .setLngLat(endCoord)
        .addTo(this.map);

      for(let i=0; i<data.length; i++){

        this.map.on('load', () => {
          this.map.addSource('route'+i, {
            'type': 'geojson',
            'data': data[i]
          });

          this.map.addLayer({
              'id': 'route'+i,
              'type': 'line',
              'source': 'route'+i,
              'layout': {
              'line-join': 'round',
              'line-cap': 'round'
            },
            'paint': {
              'line-color': 'blue',
              'line-width': 8
            }
          });
        })
      }
    });

    this.map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-84.13061823899994,34.05572881300003],
      zoom: 14,
    })

    this.map.addControl(new mapboxgl.NavigationControl());
  }
}
</script>

<style>
#map {
  min-height: 60rem;
  background: white;
  width: 100%;
  margin-top: 6rem;
  border: 1rem solid var(--light-grey);
}
</style>